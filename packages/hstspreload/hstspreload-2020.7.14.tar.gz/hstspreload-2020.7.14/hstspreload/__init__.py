"""Check if a host is in the Google Chrome HSTS Preload list"""

import functools
import os
import typing

__version__ = "2020.7.14"
__checksum__ = "6758290355652223d304ec26951c27234f650a8dfae1db9131c06e5e1ed5aa22"
__all__ = ["in_hsts_preload"]

# fmt: off
_GTLD_INCLUDE_SUBDOMAINS = {b'android', b'app', b'bank', b'chrome', b'dev', b'foo', b'gle', b'gmail', b'google', b'hangout', b'insurance', b'meet', b'new', b'page', b'play', b'search', b'youtube'}  # noqa: E501
_JUMPTABLE = [[(0, 11), (11, 5), None, (16, 57), (73, 26), (99, 12), None, (111, 19), (130, 11), (141, 7), (148, 20), (168, 18), None, (186, 22), (208, 45), (253, 7), (260, 9), (269, 36), (305, 10), (315, 10), (325, 21), None, (346, 50), (396, 8), (404, 9), (413, 19), (432, 13), (445, 14), (459, 14), None, None, (473, 29), (502, 16), (518, 35), (553, 14), (567, 24), (591, 9), None, (600, 25), (625, 20), (645, 8), (653, 13), (666, 10), None, (676, 11), (687, 6), (693, 26), (719, 5), (724, 5), (729, 10), (739, 10), (749, 11), (760, 12), (772, 27), None, (799, 11), (810, 11), (821, 7), (828, 29), (857, 18), (875, 27), (902, 46), (948, 25), (973, 16), (989, 8), (997, 5), (1002, 22), (1024, 18), None, (1042, 36), (1078, 15), (1093, 8), (1101, 5), None, (1106, 5), (1111, 16), (1127, 14), (1141, 18), None, (1159, 14), (1173, 18), (1191, 48), (1239, 19), (1258, 5), (1263, 46), (1309, 14), (1323, 14), (1337, 20), None, (1357, 10), (1367, 13), (1380, 10), (1390, 19), None, (1409, 13), (1422, 19), (1441, 5), (1446, 4), (1450, 22), (1472, 10), (1482, 7), (1489, 14), (1503, 21), (1524, 11), (1535, 10), (1545, 12), (1557, 32), None, (1589, 10), (1599, 14), (1613, 12), (1625, 45), (1670, 15), None, (1685, 11), (1696, 23), (1719, 21), (1740, 26), (1766, 6), (1772, 6), (1778, 7), (1785, 5), (1790, 20), (1810, 23), (1833, 24), (1857, 13), (1870, 15), (1885, 19), (1904, 6), (1910, 61), (1971, 44), (2015, 12), (2027, 23), (2050, 16), (2066, 38), (2104, 6), (2110, 12), (2122, 44), (2166, 6), (2172, 41), (2213, 13), (2226, 23), (2249, 30), (2279, 16), (2295, 8), (2303, 6), (2309, 12), (2321, 19), (2340, 21), (2361, 15), None, (2376, 35), (2411, 21), (2432, 17), (2449, 19), (2468, 26), (2494, 5), (2499, 37), (2536, 30), (2566, 16), (2582, 10), (2592, 17), (2609, 23), (2632, 14), (2646, 17), (2663, 8), (2671, 4), (2675, 7), (2682, 29), (2711, 6), (2717, 18), (2735, 27), (2762, 20), (2782, 17), (2799, 19), (2818, 12), (2830, 40), (2870, 40), (2910, 12), (2922, 48), (2970, 25), (2995, 12), None, (3007, 8), (3015, 20), (3035, 19), (3054, 6), (3060, 23), None, (3083, 23), (3106, 33), (3139, 14), (3153, 12), (3165, 27), None, (3192, 26), (3218, 31), (3249, 50), (3299, 15), (3314, 20), (3334, 15), (3349, 21), (3370, 32), (3402, 24), (3426, 20), (3446, 13), (3459, 60), (3519, 19), (3538, 9), (3547, 12), (3559, 12), (3571, 11), (3582, 10), (3592, 48), (3640, 32), None, (3672, 25), (3697, 12), None, (3709, 8), (3717, 8), (3725, 7), None, (3732, 25), (3757, 17), None, (3774, 21), (3795, 35), (3830, 12), (3842, 10), (3852, 36), (3888, 20), (3908, 22), (3930, 23), (3953, 19), (3972, 12), (3984, 5), (3989, 30), (4019, 24), (4043, 14), (4057, 14), (4071, 47), (4118, 46), None, None, (4164, 51), (4215, 42), None, (4257, 14), None, (4271, 15), (4286, 8), (4294, 21), (4315, 6), (4321, 16), (4337, 17)], [(4354, 6037), (10391, 6485), (16876, 6895), (23771, 5772), (29543, 6113), (35656, 5802), (41458, 6824), (48282, 5968), (54250, 6607), (60857, 5939), (66796, 6918), (73714, 6202), (79916, 6584), (86500, 6955), (93455, 6434), (99889, 6297), (106186, 6926), (113112, 5854), (118966, 6168), (125134, 6425), (131559, 6722), (138281, 6428), (144709, 6754), (151463, 5955), (157418, 6072), (163490, 6543), (170033, 6404), (176437, 6698), (183135, 6160), (189295, 6371), (195666, 6696), (202362, 6304), (208666, 6284), (214950, 6893), (221843, 5989), (227832, 6689), (234521, 6177), (240698, 6865), (247563, 6579), (254142, 6876), (261018, 7266), (268284, 6233), (274517, 6206), (280723, 5992), (286715, 6214), (292929, 5957), (298886, 6125), (305011, 6874), (311885, 6186), (318071, 5590), (323661, 6343), (330004, 6456), (336460, 6397), (342857, 6627), (349484, 6653), (356137, 6547), (362684, 6653), (369337, 5681), (375018, 6650), (381668, 5674), (387342, 6394), (393736, 6294), (400030, 6185), (406215, 6688), (412903, 6492), (419395, 6428), (425823, 5960), (431783, 6821), (438604, 6551), (445155, 6675), (451830, 6260), (458090, 6328), (464418, 5594), (470012, 6879), (476891, 6888), (483779, 6712), (490491, 5977), (496468, 7031), (503499, 6885), (510384, 5959), (516343, 6548), (522891, 5649), (528540, 6242), (534782, 6429), (541211, 6355), (547566, 6274), (553840, 6459), (560299, 6524), (566823, 6564), (573387, 6312), (579699, 7067), (586766, 5938), (592704, 6064), (598768, 6419), (605187, 6372), (611559, 6910), (618469, 6664), (625133, 6253), (631386, 6140), (637526, 6026), (643552, 6099), (649651, 6671), (656322, 6117), (662439, 6350), (668789, 5971), (674760, 6696), (681456, 6478), (687934, 6833), (694767, 7860), (702627, 6935), (709562, 6722), (716284, 6312), (722596, 6139), (728735, 6576), (735311, 6785), (742096, 6341), (748437, 6095), (754532, 6276), (760808, 6250), (767058, 6734), (773792, 6630), (780422, 6637), (787059, 7005), (794064, 6698), (800762, 7665), (808427, 6275), (814702, 5638), (820340, 6766), (827106, 6499), (833605, 7817), (841422, 6797), (848219, 6070), (854289, 6595), (860884, 6739), (867623, 6237), (873860, 6631), (880491, 5862), (886353, 6639), (892992, 6261), (899253, 6400), (905653, 6362), (912015, 7102), (919117, 6091), (925208, 6143), (931351, 6448), (937799, 6347), (944146, 6330), (950476, 6714), (957190, 6048), (963238, 6942), (970180, 6490), (976670, 6611), (983281, 6670), (989951, 6362), (996313, 6377), (1002690, 6317), (1009007, 6235), (1015242, 6248), (1021490, 6081), (1027571, 5607), (1033178, 5966), (1039144, 6424), (1045568, 7081), (1052649, 5974), (1058623, 6403), (1065026, 6831), (1071857, 6225), (1078082, 6018), (1084100, 6643), (1090743, 6326), (1097069, 5783), (1102852, 6377), (1109229, 7431), (1116660, 5858), (1122518, 6052), (1128570, 6519), (1135089, 6130), (1141219, 6569), (1147788, 6194), (1153982, 5887), (1159869, 7213), (1167082, 6556), (1173638, 6231), (1179869, 6839), (1186708, 7139), (1193847, 7202), (1201049, 6092), (1207141, 6834), (1213975, 6157), (1220132, 6478), (1226610, 6614), (1233224, 5993), (1239217, 6721), (1245938, 6830), (1252768, 6427), (1259195, 6319), (1265514, 6168), (1271682, 6269), (1277951, 6613), (1284564, 6120), (1290684, 6464), (1297148, 5760), (1302908, 6970), (1309878, 6806), (1316684, 6530), (1323214, 6778), (1329992, 5572), (1335564, 6538), (1342102, 6326), (1348428, 6506), (1354934, 6659), (1361593, 6963), (1368556, 6423), (1374979, 6521), (1381500, 6602), (1388102, 6306), (1394408, 6308), (1400716, 6361), (1407077, 6453), (1413530, 6127), (1419657, 6305), (1425962, 5886), (1431848, 7293), (1439141, 6489), (1445630, 6216), (1451846, 6624), (1458470, 6466), (1464936, 5692), (1470628, 6506), (1477134, 6391), (1483525, 7471), (1490996, 6346), (1497342, 5718), (1503060, 6886), (1509946, 6299), (1516245, 6854), (1523099, 6012), (1529111, 6071), (1535182, 5759), (1540941, 6550), (1547491, 6365), (1553856, 6726), (1560582, 6087), (1566669, 6469), (1573138, 6260), (1579398, 6909), (1586307, 6270), (1592577, 5671), (1598248, 6422), (1604670, 6101), (1610771, 6509), (1617280, 6660), (1623940, 7024), (1630964, 6120), (1637084, 6135), (1643219, 6524)], [(1649743, 703), (1650446, 625), (1651071, 628), (1651699, 663), (1652362, 523), (1652885, 611), (1653496, 644), (1654140, 808), (1654948, 640), (1655588, 627), (1656215, 509), (1656724, 544), (1657268, 758), (1658026, 886), (1658912, 936), (1659848, 714), (1660562, 1207), (1661769, 589), (1662358, 846), (1663204, 640), (1663844, 733), (1664577, 708), (1665285, 802), (1666087, 709), (1666796, 684), (1667480, 631), (1668111, 940), (1669051, 1033), (1670084, 767), (1670851, 657), (1671508, 896), (1672404, 728), (1673132, 557), (1673689, 671), (1674360, 732), (1675092, 761), (1675853, 619), (1676472, 674), (1677146, 692), (1677838, 929), (1678767, 683), (1679450, 823), (1680273, 660), (1680933, 671), (1681604, 728), (1682332, 362), (1682694, 763), (1683457, 857), (1684314, 673), (1684987, 525), (1685512, 789), (1686301, 633), (1686934, 763), (1687697, 935), (1688632, 918), (1689550, 464), (1690014, 661), (1690675, 486), (1691161, 578), (1691739, 701), (1692440, 734), (1693174, 753), (1693927, 1008), (1694935, 836), (1695771, 602), (1696373, 692), (1697065, 753), (1697818, 444), (1698262, 561), (1698823, 487), (1699310, 692), (1700002, 786), (1700788, 540), (1701328, 725), (1702053, 634), (1702687, 671), (1703358, 552), (1703910, 680), (1704590, 768), (1705358, 428), (1705786, 672), (1706458, 607), (1707065, 828), (1707893, 623), (1708516, 588), (1709104, 282), (1709386, 597), (1709983, 703), (1710686, 756), (1711442, 663), (1712105, 816), (1712921, 1074), (1713995, 788), (1714783, 773), (1715556, 674), (1716230, 436), (1716666, 938), (1717604, 858), (1718462, 564), (1719026, 580), (1719606, 666), (1720272, 843), (1721115, 839), (1721954, 541), (1722495, 632), (1723127, 697), (1723824, 363), (1724187, 467), (1724654, 924), (1725578, 863), (1726441, 792), (1727233, 774), (1728007, 610), (1728617, 771), (1729388, 643), (1730031, 683), (1730714, 689), (1731403, 433), (1731836, 639), (1732475, 588), (1733063, 914), (1733977, 653), (1734630, 789), (1735419, 404), (1735823, 703), (1736526, 656), (1737182, 835), (1738017, 883), (1738900, 738), (1739638, 904), (1740542, 747), (1741289, 524), (1741813, 757), (1742570, 583), (1743153, 737), (1743890, 715), (1744605, 639), (1745244, 682), (1745926, 589), (1746515, 640), (1747155, 594), (1747749, 691), (1748440, 691), (1749131, 637), (1749768, 437), (1750205, 549), (1750754, 641), (1751395, 556), (1751951, 683), (1752634, 594), (1753228, 761), (1753989, 520), (1754509, 490), (1754999, 656), (1755655, 551), (1756206, 607), (1756813, 639), (1757452, 796), (1758248, 594), (1758842, 609), (1759451, 841), (1760292, 826), (1761118, 522), (1761640, 695), (1762335, 796), (1763131, 587), (1763718, 659), (1764377, 480), (1764857, 580), (1765437, 621), (1766058, 714), (1766772, 598), (1767370, 898), (1768268, 676), (1768944, 794), (1769738, 683), (1770421, 649), (1771070, 580), (1771650, 646), (1772296, 699), (1772995, 1277), (1774272, 514), (1774786, 641), (1775427, 608), (1776035, 944), (1776979, 754), (1777733, 729), (1778462, 546), (1779008, 565), (1779573, 808), (1780381, 553), (1780934, 569), (1781503, 826), (1782329, 650), (1782979, 871), (1783850, 772), (1784622, 668), (1785290, 671), (1785961, 783), (1786744, 620), (1787364, 889), (1788253, 631), (1788884, 722), (1789606, 558), (1790164, 689), (1790853, 449), (1791302, 753), (1792055, 779), (1792834, 648), (1793482, 901), (1794383, 775), (1795158, 759), (1795917, 903), (1796820, 1077), (1797897, 815), (1798712, 586), (1799298, 839), (1800137, 662), (1800799, 483), (1801282, 443), (1801725, 692), (1802417, 749), (1803166, 406), (1803572, 974), (1804546, 462), (1805008, 758), (1805766, 844), (1806610, 712), (1807322, 769), (1808091, 626), (1808717, 743), (1809460, 665), (1810125, 753), (1810878, 566), (1811444, 566), (1812010, 408), (1812418, 601), (1813019, 437), (1813456, 740), (1814196, 815), (1815011, 764), (1815775, 718), (1816493, 621), (1817114, 568), (1817682, 808), (1818490, 422), (1818912, 573), (1819485, 780), (1820265, 513), (1820778, 839), (1821617, 2071), (1823688, 507), (1824195, 602), (1824797, 875), (1825672, 833), (1826505, 510)], [(1827015, 48), None, (1827063, 35), (1827098, 42), None, None, None, None, None, None, None, None, None, None, None, None, None, (1827140, 42), None, (1827182, 25), (1827207, 16), None, None, None, None, None, None, (1827223, 26), None, None, None, None, (1827249, 21), (1827270, 25), None, None, (1827295, 26), None, None, None, None, (1827321, 44), (1827365, 21), (1827386, 23), None, None, None, None, (1827409, 48), None, None, None, None, None, (1827457, 31), None, None, None, None, (1827488, 42), None, (1827530, 22), None, (1827552, 21), None, (1827573, 26), (1827599, 42), None, None, (1827641, 77), None, None, None, None, None, (1827718, 21), (1827739, 21), None, None, (1827760, 34), (1827794, 42), None, None, None, (1827836, 25), None, None, (1827861, 21), None, None, None, None, None, (1827882, 24), (1827906, 21), None, None, (1827927, 26), None, (1827953, 18), None, (1827971, 54), None, None, None, None, None, None, (1828025, 26), None, (1828051, 19), None, (1828070, 20), None, None, (1828090, 42), (1828132, 42), (1828174, 17), None, (1828191, 26), None, (1828217, 26), None, None, None, (1828243, 26), (1828269, 20), (1828289, 26), None, (1828315, 42), (1828357, 63), None, None, None, (1828420, 40), (1828460, 48), None, None, None, (1828508, 47), None, None, None, None, None, None, None, (1828555, 42), None, (1828597, 55), None, (1828652, 9), None, (1828661, 21), (1828682, 42), None, None, (1828724, 42), (1828766, 82), None, None, (1828848, 42), None, None, None, None, None, None, None, None, None, (1828890, 42), (1828932, 21), (1828953, 21), None, (1828974, 42), (1829016, 25), None, None, (1829041, 21), (1829062, 42), None, None, (1829104, 21), (1829125, 19), (1829144, 26), None, None, None, (1829170, 21), None, None, (1829191, 38), None, (1829229, 22), (1829251, 21), (1829272, 21), None, None, (1829293, 63), None, (1829356, 21), (1829377, 42), None, (1829419, 17), None, None, None, None, (1829436, 21), (1829457, 21), None, None, (1829478, 21), None, None, (1829499, 21), None, (1829520, 26), None, (1829546, 50), None, None, None, (1829596, 50), (1829646, 26), (1829672, 21), (1829693, 21), (1829714, 19), None, (1829733, 35), (1829768, 26), (1829794, 23), (1829817, 21), (1829838, 42), None, None, None, None, None, None, (1829880, 21), None, None, None, (1829901, 21), None, None, (1829922, 90), None, (1830012, 239), (1830251, 38), None, None, None, None]]  # noqa: E501
_CRC8_TABLE = [
    0x00, 0x07, 0x0e, 0x09, 0x1c, 0x1b, 0x12, 0x15,
    0x38, 0x3f, 0x36, 0x31, 0x24, 0x23, 0x2a, 0x2d,
    0x70, 0x77, 0x7e, 0x79, 0x6c, 0x6b, 0x62, 0x65,
    0x48, 0x4f, 0x46, 0x41, 0x54, 0x53, 0x5a, 0x5d,
    0xe0, 0xe7, 0xee, 0xe9, 0xfc, 0xfb, 0xf2, 0xf5,
    0xd8, 0xdf, 0xd6, 0xd1, 0xc4, 0xc3, 0xca, 0xcd,
    0x90, 0x97, 0x9e, 0x99, 0x8c, 0x8b, 0x82, 0x85,
    0xa8, 0xaf, 0xa6, 0xa1, 0xb4, 0xb3, 0xba, 0xbd,
    0xc7, 0xc0, 0xc9, 0xce, 0xdb, 0xdc, 0xd5, 0xd2,
    0xff, 0xf8, 0xf1, 0xf6, 0xe3, 0xe4, 0xed, 0xea,
    0xb7, 0xb0, 0xb9, 0xbe, 0xab, 0xac, 0xa5, 0xa2,
    0x8f, 0x88, 0x81, 0x86, 0x93, 0x94, 0x9d, 0x9a,
    0x27, 0x20, 0x29, 0x2e, 0x3b, 0x3c, 0x35, 0x32,
    0x1f, 0x18, 0x11, 0x16, 0x03, 0x04, 0x0d, 0x0a,
    0x57, 0x50, 0x59, 0x5e, 0x4b, 0x4c, 0x45, 0x42,
    0x6f, 0x68, 0x61, 0x66, 0x73, 0x74, 0x7d, 0x7a,
    0x89, 0x8e, 0x87, 0x80, 0x95, 0x92, 0x9b, 0x9c,
    0xb1, 0xb6, 0xbf, 0xb8, 0xad, 0xaa, 0xa3, 0xa4,
    0xf9, 0xfe, 0xf7, 0xf0, 0xe5, 0xe2, 0xeb, 0xec,
    0xc1, 0xc6, 0xcf, 0xc8, 0xdd, 0xda, 0xd3, 0xd4,
    0x69, 0x6e, 0x67, 0x60, 0x75, 0x72, 0x7b, 0x7c,
    0x51, 0x56, 0x5f, 0x58, 0x4d, 0x4a, 0x43, 0x44,
    0x19, 0x1e, 0x17, 0x10, 0x05, 0x02, 0x0b, 0x0c,
    0x21, 0x26, 0x2f, 0x28, 0x3d, 0x3a, 0x33, 0x34,
    0x4e, 0x49, 0x40, 0x47, 0x52, 0x55, 0x5c, 0x5b,
    0x76, 0x71, 0x78, 0x7f, 0x6a, 0x6d, 0x64, 0x63,
    0x3e, 0x39, 0x30, 0x37, 0x22, 0x25, 0x2c, 0x2b,
    0x06, 0x01, 0x08, 0x0f, 0x1a, 0x1d, 0x14, 0x13,
    0xae, 0xa9, 0xa0, 0xa7, 0xb2, 0xb5, 0xbc, 0xbb,
    0x96, 0x91, 0x98, 0x9f, 0x8a, 0x8d, 0x84, 0x83,
    0xde, 0xd9, 0xd0, 0xd7, 0xc2, 0xc5, 0xcc, 0xcb,
    0xe6, 0xe1, 0xe8, 0xef, 0xfa, 0xfd, 0xf4, 0xf3
]
# fmt: on

_IS_LEAF = 0x80
_INCLUDE_SUBDOMAINS = 0x40


try:
    from importlib.resources import open_binary

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open_binary("hstspreload", path)


except ImportError:

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open(
            os.path.join(os.path.dirname(os.path.abspath(__file__)), path), "rb",
        )


@functools.lru_cache(maxsize=1024)
def in_hsts_preload(host: typing.AnyStr) -> bool:
    """Determines if an IDNA-encoded host is on the HSTS preload list"""

    if isinstance(host, str):
        host = host.encode("ascii")
    labels = host.lower().split(b".")

    # Fast-branch for gTLDs that are registered to preload all sub-domains.
    if labels[-1] in _GTLD_INCLUDE_SUBDOMAINS:
        return True

    with open_pkg_binary("hstspreload.bin") as f:
        for layer, label in enumerate(labels[::-1]):
            # None of our layers are greater than 4 deep.
            if layer > 3:
                return False

            # Read the jump table for the layer and label
            jump_info = _JUMPTABLE[layer][_crc8(label)]
            if jump_info is None:
                # No entry: host is not preloaded
                return False

            # Read the set of entries for that layer and label
            f.seek(jump_info[0])
            data = bytearray(jump_info[1])
            f.readinto(data)

            for is_leaf, include_subdomains, ent_label in _iter_entries(data):
                # We found a potential leaf
                if is_leaf:
                    if ent_label == host:
                        return True
                    if include_subdomains and host.endswith(b"." + ent_label):
                        return True

                # Continue traversing as we're not at a leaf.
                elif label == ent_label:
                    break
            else:
                return False
    return False


def _iter_entries(data: bytes) -> typing.Iterable[typing.Tuple[int, int, bytes]]:
    while data:
        flags = data[0]
        size = data[1]
        label = bytes(data[2 : 2 + size])
        yield (flags & _IS_LEAF, flags & _INCLUDE_SUBDOMAINS, label)
        data = data[2 + size :]


def _crc8(value: bytes) -> int:
    # CRC8 reference implementation: https://github.com/niccokunzmann/crc8
    checksum = 0x00
    for byte in value:
        checksum = _CRC8_TABLE[checksum ^ byte]
    return checksum
